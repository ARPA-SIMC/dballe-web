{% extends "base.html" %}

{% block head %}
<style type="text/css">
#map { height: 30em; }
</style>
<script type="text/javascript">
(function($) {
  var server;

  function set_options(field, options)
  {
    field = $(field);
    field.empty();
    for (var i = 0; i < options.length; ++i)
    {
      if (options[i] instanceof Array)
        field.append($("<option>").attr("value", options[i][0]).text(options[i][1]));
      else
        field.append($("<option>").attr("value", options[i]).text(options[i]));
    }
  }

  async function update_filter()
  {
    var stats = await server.get_filter_stats();

    if (stats.empty)
    {
      $("#filter_fields").attr("disabled", true);
    } else {
      set_options("#filter-repmemo", stats.choices.rep_memo)
      set_options("#filter-var", stats.choices["var"])
      set_options("#filter-level", stats.choices.level)
      set_options("#filter-trange", stats.choices.trange)
      $("#filter_fields").attr("disabled", false);
    }
  }

  async function update_data()
  {
    var data = await server.get_data();

    var tbody = $("#data tbody");
    tbody.empty();

    for (var i = 0; i < data.rows.length; ++i)
    {
      var row = data.rows[i];
      var tr = $("<tr>");
      tr.append($("<td>").text(row[0]));
      tr.append($("<td>").text(row[1]));
      tr.append($("<td>").text(row[2]));
      tr.append($("<td>").text(row[3]));
      tr.append($("<td>").text(row[4]));
      tr.append($("<td>").text(row[5]));
      tr.append($("<td>").text(row[6]));
      tbody.append(tr);
    }
  }

  function setup_map(id)
  {
    // OSM base layer
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data Â© OpenStreetMap contributors';
    var map = L.map(id).setView([51.505, -0.09], 13);

    var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 12, attribution: osmAttrib, boxZoom: false});
    map.addLayer(osm);

    // Show the mouse position in the map
    L.control.mousePosition({ position: "bottomright" }).addTo(map);

    // Add the rectangle selection facility
    var selectfeature = map.boxSelect.enable();
    //var selectfeature = map.selectAreaFeature.enable();
    //var locationFilter = new L.LocationFilter({ buttonPosition: "bottomleft", adjustButton: null }).addTo(map);
    /*
    locationFilter.on("change", function(e) {
      window.provami.js_area_selected(e.bounds.getNorth(), e.bounds.getSouth(), e.bounds.getWest(), e.bounds.getEast());
    });
    locationFilter.on("enabled", function(e) {
      window.provami.js_area_selected(e.bounds.getNorth(), e.bounds.getSouth(), e.bounds.getWest(), e.bounds.getEast());
    });
    locationFilter.on("disabled", function(e) {
      window.provami.js_area_unselected();
    });
    */
  }

  async function main()
  {
    $("#filter_fields").attr("disabled", true);

    setup_map("map");

    server = new window.provami.Provami();
    server.on("new_filter", msg => { update_filter().then(); });

    await Promise.all([update_filter(), update_data()]);

    $("#filter").submit(() => { return false; });
  }
  $(document).ready(() => { main().then(); });
})(jQuery);
</script>
{% end %}

{% block body %}
<div class="row">

<div class="col-md-4">
<div class="panel panel-default">
  <div class="panel-heading">Filter</div>
  <div class="panel-body">
  <form id="filter">
    <fieldset id="filter_fields">
    <label for="filter-repmemo">Network</label>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-asterisk" id="filter-repmemo-addon"></span>
      <select class="form-control" id="filter-repmemo" aria-describedby="filter-repmemo-addon">
      </select>
    </div>
    <label for="filter-var">Variable</label>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-pencil" id="filter-var-addon"></span>
      <select class="form-control" id="filter-var" aria-describedby="filter-var-addon">
      </select>
    </div>
    <label for="filter-level">Level</label>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-resize-vertical" id="filter-level-addon"></span>
      <select class="form-control" id="filter-level" aria-describedby="filter-level-addon">
      </select>
    </div>
    <label for="filter-trange">Time range</label>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-resize-horizontal" id="filter-trange-addon"></span>
      <select class="form-control" id="filter-trange" aria-describedby="filter-trange-addon">
      </select>
    </div>
    </fieldset>
  </form>
  </div>
</div>
</div>

<div class="col-md-8">
  <div class="panel panel-default">
    <div class="panel-heading">Stations</div>
    <div class="panel-body" id="map">
    </div>
  </div>
</div>

</div>

<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">Data</div>
      <div class="panel-body">
        <table id="data" class="table table-striped">
          <thead>
            <tr>
              <th>Network</th>
              <th>Station</th>
              <th>Variable</th>
              <th>Level</th>
              <th>Time range</th>
              <th>Datetime</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% end %}
