{% extends "base.html" %}

{% block head %}
<script type="text/javascript">
(function($) {
  var server;

  function on_message(msg)
  {
    var parsed = $.parseJSON(msg.data);
    // console.log("Message:", parsed);
    if (parsed.channel == "api")
    {
      // console.log("provami api message", parsed.response);
      if (parsed["function"] == "ping")
        $("#test").append($("<pre>").text("PING:" + JSON.stringify(parsed)));
      else if (parsed["function"] == "async_ping")
        $("#test").append($("<pre>").text("ASYNC PING:" + JSON.stringify(parsed)));
    }
    else if (parsed.channel == "events")
    {
      if (parsed.type == "new_filter")
        $("#test").append($("<pre>").text("FILTER OPTIONS: " + JSON.stringify(parsed.options)));
    }
    else if (parsed.channel == "provami:updates")
    {
      console.log("Update", parsed);
    }
  }

  async function main()
  {
    server = new window.provami.Provami();

    var res = await server.ping();
    $("#test").append($("<pre>").text("PING:" + JSON.stringify(res)));

    res = await server.async_ping();
    $("#test").append($("<pre>").text("ASYNC PING:" + JSON.stringify(res)));

    window.ws_connection.on("message", on_message);
//    window.ws_connection.send({ "channel": "api", "function": "ping" })
//    window.ws_connection.send({ "channel": "api", "function": "async_ping" })
  }
  $(document).ready(() => { main().then(); });
})(jQuery);
</script>
{% end %}

{% block body %}
<div id="test">
</div>
{% end %}
