<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="MarkerCluster.css" />
  <link rel="stylesheet" href="MarkerCluster.Default.css" />
  <link rel="stylesheet" href="locationfilter.css" />
  <link rel="stylesheet" href="L.Control.MousePosition.css" />
  <script src="leaflet-src.js"></script>
	<script src="leaflet.markercluster.js"></script>
	<script src="locationfilter.js"></script>
  <script src="L.Control.MousePosition.js"></script>
  <style>
    body { padding: 0; margin: 0; }
    html, body, #map { height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
</body>
<script type="text/javascript">

// Set a selected icon
L.Icon.Selected = L.Icon.Default.extend({
	_getIconUrl: function (name) {
		var key = name + 'Url';

		if (this.options[key]) {
			return this.options[key];
		}

		if (L.Browser.retina && name === 'icon') {
			name += '-2x';
		}

		var path = L.Icon.Default.imagePath;

		if (!path) {
			throw new Error('Couldn\'t autodetect L.Icon.Default.imagePath, set it manually.');
		}

		return path + '/marker-selected-' + name + '.png';
	}
});

// Map
var map = L.map('map');
// Markers layer
var markers = null;
// Maps station IDs to Marker objects
var markers_by_id = {}

//.setView([51.505, -0.09], 13);

// OSM base layer
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data Â© OpenStreetMap contributors';
var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 12, attribution: osmAttrib});		
map.addLayer(osm);

// Show the mouse position in the map
L.control.mousePosition({ position: "bottomright" }).addTo(map);

// Add the rectangle selection facility
var locationFilter = new L.LocationFilter({ buttonPosition: "bottomleft", adjustButton: null }).addTo(map);
locationFilter.on("change", function(e) {
  window.provami.js_area_selected(e.bounds.getNorth(), e.bounds.getSouth(), e.bounds.getWest(), e.bounds.getEast());
});
locationFilter.on("enabled", function(e) {
  window.provami.js_area_selected(e.bounds.getNorth(), e.bounds.getSouth(), e.bounds.getWest(), e.bounds.getEast());
});
locationFilter.on("disabled", function(e) {
  window.provami.js_area_unselected();
});

// start the map in South-East England
map.setView([51.3, 0.7], 5);

function select_marker(id)
{
  locationFilter.disable();
  window.provami.js_station_selected(id);
}

function set_selected_stations(ids)
{
  var selected = {};
  for (var i = 0; i < ids.length; ++i)
    selected[ids[i]] = true;

  for (var id in markers_by_id)
  {
    if (selected[id])
    {
      markers_by_id[id].setIcon(new L.Icon.Selected);
    }
    else
    {
      markers_by_id[id].setIcon(new L.Icon.Default);
    }
  }
}

function station_clicked(evt)
{
  select_marker(evt.target.options.id);
}

function set_stations(data)
{
  if (markers != null)
    map.removeLayer(markers);
  markers = null;
  markers_by_id = {};

  if (!data.length) return;

  markers = L.markerClusterGroup({ maxClusterRadius: 30 });
  //markers = L.featureGroup();
  var points = [];

  // Compute the bounding box of the points
  for (var i = 0; i < data.length; ++i)
  {
    var id = data[i][0];
    var lat = data[i][1];
    var lon = data[i][2];
    points.push([lat, lon]);
    var marker = L.marker(new L.LatLng(lat, lon), { title: id, id: id });
    markers_by_id[id] = marker;
    marker.on("click", station_clicked);
    markers.addLayer(marker);
  }

  map.addLayer(markers);

  var bounds = L.latLngBounds(points);
  map.fitBounds(bounds);
}

/*

access_token = 'pk.eyJ1Ijoic25vcmZhbG9ycGFndXMiLCJhIjoic1oxRTMxcyJ9.eC6cjtLmFs9EcVwmT1isOQ';
L.tileLayer('https://{s}.tiles.mapbox.com/v4/examples.map-i86nkdio/{z}/{x}/{y}@2x.png?access_token='+access_token, {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
    id: 'examples.map-i86nkdio',
}).addTo(map);

var marker = L.marker(map.getCenter()).addTo(map);
marker.bindPopup("Hello World!").openPopup();

if(typeof MainWindow != 'undefined') {
    var onMapMove = function() { MainWindow.onMapMove(map.getCenter().lat, map.getCenter().lng) };
    map.on('move', onMapMove);
    onMapMove();
}
*/
</script>
</html>
